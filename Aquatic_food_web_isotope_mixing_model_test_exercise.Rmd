---
title: "Isotope Mixing Model Exercise"
author: "Hannah M Carroll and Derek D Houston"
<<<<<<< Updated upstream
date: "June 30, 2019"
=======
date: "August 1st, 2019"
>>>>>>> Stashed changes
output: word_document

---

- This exercise will walk you through creating an isotope mixing model from the data we worked with in the food web exercise.

- Set your working directory by choosing Session from the menu at the top, then Set Working Directory -> To Source File Location

---

NOTE: WHEN YOU ARE DONE WITH THIS EXERCISE, KNIT THIS FILE TO WORD AND SUBMIT VIA BLACKBOARD

Your name:

---

Now we'll install and load the packages we need
```{r}

install.packages(c("dplyr", "simmr"))
library(dplyr)
library(simmr)

```

---

<<<<<<< Updated upstream
Load the iso.data.clean2 dataset that we created in the Aquatic Food Web Exercise if it isn't already in your Global Environment. If it is in your Global Environment already, you can skip this step.
=======
Load the iso.data.clean2 dataset that we created in the Aquatic Food Web Exercise if it isn't already in your Global Environment (upper right window).

If it is in your Global Environment already, you can skip this step.
>>>>>>> Stashed changes
```{r}

iso.data.clean2 <- read.csv("isodataclean2.csv", header=TRUE)

```

---

We are using the package simmr to create an isotope mixing model of food sources for both the trout (apex predator) and leech. We assumed that the leech was parasitic, but the food web analysis we completed indicated that we probably have a free-living, nonparasitic leech instead. The mixing model will evaluate the diet contributions and either confirm or refute our *a priori* trophic level assignment.

The first set of steps creates the model for trout.

- The simmr package requires that we extract parts of our dataset in a very precise way. Follow these steps carefully to ensure you create the correct model.

- You can view help files for any package by typing help(packagename)
```{r}

# View the help file for the simmr package:
help("simmr")

# After skimming the simmr helpfile, continue the exercise.

```

---

<<<<<<< Updated upstream
We will need to subset our data frame called iso.data.clean2 in several separate steps. You can open the data frame in spreadsheet form to view it easily. Leave it open in another tab as you work so that you can refer back. You can also view objects by clicking the small white icon to the right of the object name in the Global Environment.
=======
- We will need to subset our data frame called iso.data.clean2 in several separate steps. Subsetting means you are selecting a portion of your existing data and ignoring or removing the rest.

- You can open the data frame in spreadsheet form to view it easily. 
- Leave it open in another tab as you work so that you can refer back. 
- You can also view objects by clicking the small white icon to the right of the object name in the Global Environment.
>>>>>>> Stashed changes
```{r}
View(iso.data.clean2)

# (1pt) View the dataset. What is the ID and trophic level of the organism on row 17 of the data frame?
#

```

---

In simmr, the *mix* is the organism or organisms for which we are examining diet. We'll start by looking at the diet of our trout.
```{r}

# It's most efficient to combine operations when practical. The line of code below can be read in sentence form as follows:

# Create an object called trout.mix. Subset iso.data.clean2 to include only row 17 (the row containing the trout data), and columns 5 to 6 (d13C and d15N). Return these items in matrix form and assign them to the object trout.mix.

<<<<<<< Updated upstream
trout.mix <- as.matrix(iso.data.clean2[17, 5:6])
# Note that you can quickly call a row or column in a data frame by indexing like this: dfname[row, column]
# The square brackets are always used for indexing.
# Leaving a blank either before or after the comma means you want to include all rows/columns.
=======
#(1pt) There are usually multiple ways to call data in R. Column indexing allows you to call any combination of rows and/or columns. On the line below, call row 12, and all columns of the iso.data.clean2 dataset, without assigning it to an object (i.e., without using <-). Remember, the form is df[row, column]


```

Now we will turn our trout.mix data frame into a matrix that simmr can use
```{r}
>>>>>>> Stashed changes

#(1pt) On the line below, call row 12, all columns of the iso.data.clean2 dataset, without assigning it to an object


```

---

Now we'll set column names of our trout.mix matrix
```{r}
# Set the column names
# Note that the c on the right side of the arrow means "combine" and is used to tell R you are giving it multiple pieces of information.
colnames(trout.mix) <- c("d13C", "d15N")

# (1pt) trout.mix is a small matrix. Call it by name on the line below to look at the data.


```

---

Next, we'll create a matrix of data for the trout's potential food sources.

The package magrittr gives us the ability to use pipes to efficiently perform operations. Pipes are the symbols %>%. They link many commands together to process complex data or perform multiple operations in the same step. The code below combines the data processing abilities of the dplyr package with the pipes from magrittr.

```{r}

# The d13C and d15N of the trout's potential food sources need to be averaged by type (mayflies, stoneflies, algae, etc.). That information is stored in the ID column.

# Since we are now looking at potential food sources, we have to REMOVE the trout from this part of the data. We can use column indexing like we did above, but with a minus sign to indicate that it should be left out.

# The first line is creating an object called source.means, to which we assign the output. We start by dropping the trout row (row 17), and taking the ID column (3), d13C colun (5), and d15N column (6) for the rest of the rows.
source.means <- as.matrix(iso.data.clean2[-17, c(3,5:6)] %>% 
  group_by(ID) %>% # This line then groups the data by ID
  summarize_all(.funs = c(mean="mean"))) # This line then calculates the mean d15C and d15N by the groups we created above

# Because we have wrapped everything above in the as.matrix() function, source.means is a matrix. 
# (1pt) Check that this step worked by asking R for the class of the source.means object on the line below:
class(source.means)

<<<<<<< Updated upstream
# Some of our IDs have only one observation. We can't create a meaningful average for those, so we have to remove them. We have only one observation each for Amphipods (row 2), Caddisflies (row 3), Leeches (row 4), and Wood (row 8).
# We also need to drop the ID column that we had used for grouping
=======
```{r}

# Some of our IDs have only one observation. We can't create a meaningful average for those, so we have to remove them. We have only one observation each for Amphipods (row 2), Caddisflies (row 3), Leeches (row 4), and Wood (row 8). We will ignore those, and just use rows 1 and 5 through 7.
# We also need to drop the ID column (column 1) that we had used for grouping. To drop a column, we put a minus sign before the column number.
>>>>>>> Stashed changes
source.means2 <- source.means[c(1,5:7), -1]

# (2pts) On the line below write an explanation of what the code on line 121 is doing:
#

# (1pt) Our data need to be in numeric form for analysis. Look in your Global Environment. Are the data in numeric (num) or character (chr) format?
# 

# Convert the data to numeric form using the line below:
source.means3 <- apply(source.means2, 2, as.numeric) 

```

---

We now need to get the names (ID) of the potential food sources. This is stored in column 1 of source.means.
```{r}

source.names <- source.means[c(1,5:7), 1]

# (2pts) On the line below, write an explanation of what the code on line 139 is doing:
#

# (1pt) Call the source.names object by name to make sure we have the correct names:


```

---

Now we will get the standard deviation of the d15C and d15N values for the trout's potential food sources
```{r}

source.sds <- as.matrix(iso.data.clean2[-17, c(3, 5:6)] %>%
  group_by(ID) %>%
  summarize_all(.funs = c(sd="sd")))

# (2pts) On the line below, write an explanation in your own words of what the code on line 154 is doing. Remember that you can refer to the means step for help.
#
# (2pts) On the line below, write an explanation in your own words of what the code on line 155 is doing.
#
# (2pts) On the line below, write an explanation in your own words of what the code on line 156 is doing.
#

source.sds2 <- source.sds[c(1, 5:7), 2:3]
# (2pts) On the line below, write an explanation in your own words of what the code on line 165 is doing.
#
source.sds3 <- apply(source.sds2, 2 ,as.numeric) 
# (2pts) On the line below, write an explanation in your own words of what the code on line 168 is doing.
#

```

---

<<<<<<< Updated upstream
=======
The *apply* function will apply any other function that you specify over the margins (rows or columns) of a matrix or vector.
```{r}

# A matrix can only contain one data type (character, numeric, factor, etc.). Because we converted our data frame to a matrix without removing the ID column first (character), it recoded all of our variables to character. We now need to convert the data type of both variables to numeric.

source.sds3 <- apply(source.sds2, 2, as.numeric) # This line is applying the as.numeric function to the columns (1 for rows, or 2 for columns) of the source.sds2 matrix.

# (2pts) What is the class of the source.sds3 object? Remember that you can find the class using the command class(objectname).


```

---

Simmr lets us include the % carbon and nitrogen of the potential food sources' tissues in our analyses as the *concentration*. This helps improve the robustness of our diet estimates. 

>>>>>>> Stashed changes
We will use the colummns for the carbon and nitrogen percentages of the trout's potential food sources as the concentration values.
```{r}

conc <- as.matrix(iso.data.clean2[-17, c(3, 7:8)] %>%
  group_by(ID) %>%
  summarize_all(.funs = c(mean="mean")))

conc2 <- conc[c(1, 5:7), 2:3]

conc3 <- apply(conc2, 2, as.numeric) 

# (1pt) On the line below, use the command dim(name) to find out what the dimensions of conc3 are


```

---

Now we have all of the data we need to create the model. The simmr_load command puts everything into the correct format for the mixing model.
```{r}

trout.simmr.in = simmr_load(mixtures=trout.mix,
                     source_names=source.names,
                     source_means=source.means3,
                     source_sds=source.sds3,
                     concentration_means = conc3)

# (1pt) What is the class of trout.simmr.in? Write the command to find the class on the line below and execute the code.


```

---

Let's make a plot of the isospace of our aquatic macroinvertebrate community
```{r}

# You can use expressions to include symbols in plots. Delta can be called by name in an expression, and ^ indicates that what comes next should be superscript. Note the placement of the quotation marks - these are key for getting the labels to work.
plot(trout.simmr.in, xlab=expression(paste(delta^13, "C (\u2030)",sep="")), # \u2030 is the unicode for the permil symbol
     ylab=expression(paste(delta^15, "N (\u2030)",sep="")), 
     title="Isospace plot of potential trout food sources")

```

---

```{r}
# The command simmr_mcmc creates a model using Markov chain Monte Carlo.
trout.simmr.out = simmr_mcmc(trout.simmr.in)

```

---

We now need to make sure the model has run correctly. We can get diagnostics using the summary command.
```{r}

summary(trout.simmr.out,type='diagnostics')

# (1pt) Did our model run correctly? What evidence do you see?
#

```

---

We now have everything we need to estimate the food sources of the trout
```{r}
# This command creates a box and whisker plot of the potential food sources
compare_sources(trout.simmr.out)

# (1pt) What is the trout's main food source?
#
# (1pt) Look in the console at the bottom of your screen. What is the probability that the trout's diet consists of Stoneflies > Algae > Midges > Mayflies?
#

```

---

Now you will use everything we've done above to create an estimate of diet for the leech.

Remember that R code needs to be inserted into code chunks. Use *Ctrl+Alt+I* to insert a chunk on a Windows machine, or *Command+Alt+I* on a Mac.

---

- You can reuse all the code we wrote above, changing the column indexes and object names estimate diet for the leech instead of the trout
- Don't forget that you can use View(iso.data.clean2) (capital V!) at any time to see your dataset as a spreadsheet.

---

(25 points total)


(2pts) Create the mix object for the leech


(1pt) Set the column names for the leech


(2pts) Create the source means object. Remember that you will need to do this in three steps and end up with numeric values in a matrix.


(2pts) Create the source names object from the ID column.


(2pts) Create the source sds object.


(2pts) Create the concentration object from the carbon and nitrogen percentages.


(2pts) Create the simmr_in object. Call it leech.simmr.in


(1pt) Create the isospace plot of leech.simmr.in


(2pts) Create leech.simmr.out using the simmr_mcmc command


(2pts) Get diagnostics on leech.simmr.out using the summary command


(2pts) Produce the box and whisker plot comparing the sources in the leech's diet


(5pts) We assumed that this leech was parasitic when we initially collected it. Were those assumptions correct? What makes up the greatest proportion of the leech's diet? Is it free-living or parasitic?

---
